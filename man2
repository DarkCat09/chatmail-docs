doas addgroup -S vmail
doas adduser -h /home/vmail -s /bin/false -G vmail -S -D vmail

doas addgroup -S iroh
doas adduser -s /bin/false -G iroh -S -D -H iroh

doas apk add python3 py3-virtualenv
doas python3 -m venv /opt/chatmaild

mkdir ~/cm
cd ~/cm

:: on host
  git clone https://github.com/chatmail/relay.git
  cd relay
  docker run -it --rm -v ./:/src alpine:latest sh -c 'apk add python3 py3-pip gcc musl-dev python3-dev && pip wheel -w /src/dist /src/chatmaild'
  scp -P 8022 ./dist/*.whl chat.example.com:/home/user/cm
  cd ..

doas /opt/chatmaild/bin/pip install ./*.whl
rm ./*.whl

:: on host
  git clone https://git.dc09.xyz/chatmail/openrc.git
  cd openrc
  vim chatmail-turn  # replace domain in --realm
  scp -P 8022 ./* chat.example.com:/home/user/cm
  cd ..

doas crontab -l >cron.bkp
cat cron.bkp crontab | doas crontab -
rm cron.bkp crontab

doas chown root: ./*
doas chmod 755 ./*
doas mv ./* /etc/init.d

curl -L -o ./chatmail-turn 'https://github.com/chatmail/chatmail-turn/releases/download/v0.3/chatmail-turn-x86_64-linux'
echo '841e527c15fdc2940b0469e206188ea8f0af48533be12ecb8098520f813d41e4 chatmail-turn' | sha256sum -c
doas chown root: chatmail-turn
doas chmod 755 chatmail-turn
doas mv chatmail-turn /usr/local/bin/

curl -L -o iroh.tar.gz 'https://github.com/n0-computer/iroh/releases/download/v0.35.0/iroh-relay-v0.35.0-x86_64-unknown-linux-musl.tar.gz'
tar xzf iroh.tar.gz
rm iroh.tar.gz
echo '45c81199dbd70f8c4c30fef7f3b9727ca6e3cea8f2831333eeaf8aa71bf0fac1 iroh-relay' | sha256sum -c
doas chown root: iroh-relay
doas chmod 755 iroh-relay
doas mv iroh-relay /usr/local/bin/

:: on host
  cd relay
  python -m venv venv
  venv/bin/pip install -e ./chatmaild -e ./cmdeploy
  venv/bin/cmdeploy init chat.example.com
  vim chatmail.ini
  scp -P 8022 \
    ./chatmail.ini \
    ./cmdeploy/src/cmdeploy/iroh-relay.toml \
    ./cmdeploy/src/cmdeploy/opendkim/*.lua \
    chat.example.com:/home/user/cm
  cd ..

echo 'chat.example.com' | doas tee /etc/mailname

doas chown root: chatmail.ini iroh-relay.toml
doas mv chatmail.ini iroh-relay.toml /etc/

doas apk add opendkim opendkim-utils dnssec-root
doas apk add postfix

doas vim /etc/opendkim/opendkim.conf
:: put the contents adjusting domain (1 time)
```
Syslog yes
SyslogSuccess yes
LogWhy no

Canonicalization relaxed/simple
OversignHeaders from,reply-to,subject,date,to,cc,resent-date,resent-from,resent-sender,resent-to,resent-cc,in-reply-to,references,list-id,list-help,list-unsubscribe,list-subscribe,list-post,list-owner,list-archive,autocrypt
SignHeaders *,+autocrypt,+content-type

On-BadSignature reject
On-KeyNotFound reject
On-NoSignature reject
DNSTimeout 60

Domain chat.example.com  # <-- CHANGE TO YOUR DOMAIN
Selector opendkim
KeyFile /etc/dkimkeys/opendkim.private
KeyTable /etc/dkimkeys/KeyTable
SigningTable refile:/etc/dkimkeys/SigningTable

ScreenPolicyScript /etc/opendkim/screen.lua
FinalPolicyScript /etc/opendkim/final.lua

UserID opendkim
UMask 007
Socket local:/var/spool/postfix/opendkim/opendkim.sock
PidFile /run/opendkim/opendkim.pid

TrustAnchorFile /usr/share/dnssec-root/trusted-key.key

MTA ORIGINATING
InternalHosts -
```

doas chown root: *.lua
doas mv screen.lua final.lua /etc/opendkim/
doas mkdir /etc/dkimkeys

doas vim /etc/dkimkeys/KeyTable
:: put the contents adjusting domain (2 times)
```
opendkim._domainkey.chat.example.com chat.example.com:opendkim:/etc/dkimkeys/opendkim.private
```

doas vim /etc/dkimkeys/SigningTable
:: put the contents adjusting domain (2 times)
```
*@chat.example.com opendkim._domainkey.chat.example.com
```

doas chown opendkim: /etc/opendkim
doas chown -R opendkim: /etc/dkimkeys
doas chmod 750 /etc/opendkim /etc/dkimkeys

doas -u opendkim opendkim-genkey -D /etc/dkimkeys -d chat.example.com -s opendkim

doas mkdir /var/spool/postfix/opendkim
doas chown opendkim: /var/spool/postfix/opendkim
doas chmod 750 /var/spool/postfix/opendkim

cd /etc/apk/keys
doas curl -JO https://git.dc09.xyz/api/packages/chatmail/alpine/key
echo '@chatmail https://git.dc09.xyz/api/packages/chatmail/alpine/3.23/chatmail' | doas tee -a /etc/apk/repositories
doas apk add dovecot@chatmail dovecot-openrc@chatmail dovecot-lmtpd@chatmail
cd ~/cm

doas vim /etc/dovecot/dovecot.conf
:: put the contents adjusting domain (2 times),
   tls certs location and mailbox quotas
```
protocols = imap lmtp
auth_mechanisms = plain

default_client_limit = 20000

# Each connection is handled by a separate `imap` process
service imap {
  process_limit = 50000
}

mail_server_admin = mailto:root@chat.example.com  # <-- HERE
mail_server_comment = Chatmail server

# Mailbox compression and limits
mail_plugins = zlib quota
# Chatmail custom capabilities
imap_capability = +XDELTAPUSH XCHATMAIL

# Authentication
passdb {
  driver = dict
  args = /etc/dovecot/auth.conf
}
userdb {
  driver = dict
  args = /etc/dovecot/auth.conf
}

##
## Mailbox locations and namespaces

# /home/vmail/mail/(host)/(user)
mail_location = maildir:/home/vmail/mail/chat.example.com/%u  # <-- HERE

# change locking behavior according to
# alpine's default dovecot config
mbox_write_locks = fcntl

# index & cache files are not very useful for chatmail
mail_cache_max_size = 500K

namespace inbox {
  inbox = yes

  mailbox Drafts {
    special_use = \Drafts
  }
  mailbox Junk {
    special_use = \Junk
  }
  mailbox Trash {
    special_use = \Trash
  }

  mailbox Sent {
    special_use = \Sent
  }
  mailbox "Sent Messages" {
    special_use = \Sent
  }
}

mail_uid = vmail
mail_gid = vmail
mail_privileged_group = vmail

##
## Mail processes

# Pass all IMAP METADATA requests to the chatmail-metadata service
mail_attribute_dict = proxy:/run/chatmail-metadata/metadata.socket:metadata

protocol imap {
  mail_plugins = $mail_plugins imap_quota last_login
  # in case you want to enable IMAP COMPRESS (see `imap_compress` in chatmail.ini)
  #mail_plugins = $mail_plugins imap_quota last_login imap_zlib

  imap_metadata = yes
}

plugin {
  last_login_dict = proxy:/run/chatmail-lastlogin/lastlogin.socket:lastlogin
  #last_login_key = last-login/%u  # default
  last_login_precision = s
}

protocol lmtp {
  mail_plugins = $mail_plugins mail_lua notify push_notification push_notification_lua
}

plugin {
  zlib_save = gz
}

plugin {
  imap_compress_deflate_level = 6
}

plugin {
  # ADJUST MAILBOX QUOTAS
  quota = maildir:User quota
  quota_rule = *:storage=100M   # <-- max_mailbox_size in chatmail.ini
  quota_max_mail_size=31457280  # <-- max_message_size
  quota_grace = 0
}

# push_notification configuration
plugin {
  push_notification_driver = lua:file=/etc/dovecot/push_notification.lua
}

service lmtp {
  user = vmail

  unix_listener /var/spool/postfix/private/dovecot-lmtp {
    group = postfix
    mode = 0600
    user = postfix
  }
}

service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  }
}

service auth-worker {
  # Drop privileges we don't need
  user = vmail
}

service imap-login {
  # High-performance mode
  service_count = 0

  # Increase virtual memory size limit
  vsz_limit = 1G

  # Avoid startup latency for new connections.
  # Should be set to at least the number of CPU cores
  # according to the documentation
  process_min_avail = 10
}

service anvil {
  # No point in anvil penalty as it detects brute-forcing
  # only by IP address, not by username.
  # A correct IP address is not passed to Dovecot anyway
  unix_listener anvil-auth-penalty {
    mode = 0
  }
}

# ADJUST PATHS TO TLS CERTS
ssl = required
ssl_cert = </etc/letsencrypt/live/chat.example.com/fullchain.pem  <-- HERE
ssl_key = </etc/letsencrypt/live/chat.example.com/privkey.pem     <-- HERE
ssl_dh = </etc/dovecot/dh.pem
ssl_min_protocol = TLSv1.3
ssl_prefer_server_ciphers = yes

# Hibernate IDLE users to save memory and CPU resources
# NOTE: this will have no effect if imap_zlib plugin is used
#       i.e. when IMAP COMPRESS is enabled
imap_hibernate_timeout = 30s
service imap {
  # Note that this change will allow any process running as
  # $default_internal_user (dovecot) to access mails as any other user.
  # This may be insecure in some installations, which is why this isn't
  # done by default.
  unix_listener imap-master {
    user = $default_internal_user
  }
}
service imap {
  extra_groups = $default_internal_group
}
service imap-hibernate {
  unix_listener imap-hibernate {
    mode = 0660
    group = $default_internal_group
  }
}
```

doas vim /etc/dovecot/dh.pem
:: afaik it's safe to just copy these
  i generated them via `openssl dhparam 4096 >dh.pem`
  (run on a host with sufficient entropy!)
```
-----BEGIN DH PARAMETERS-----
MIICDAKCAgEAyvlzzX8sCG2iHMMa0ywepwE6ssGio+TJHhppS0dUYVIgUulUIa8I
h1EGOH48hMhM0fHXR/xbBrIAygQGJwGwhVZbE+iXKjGF/i+0ms4eCSrhw//HQcVH
jq5UD7aDKTfAwdIqp+a5GkId/UZUVr9dVG8OfR81EGkBgQEp2P3A9nxux8KfNquj
t1cZhwwkeAVS0/FG4pk/vFK+z1qsGAxluE8hdEmbgL/EqzgRvWLZNDTr2BE0OS7L
rCYZDwwvcJVuidVHW9GrlgwO7PC2Y4sFYfQHuhpMaoLLl3C4OiYb7UGE0cNm7W7D
zy5ckuhNimWmRw3HlxiB4pNfLpPWtA2b+oyXlmKZDUgW3tUsdOzIbfMwDctmGF1G
iivBJk72ltjMO7+ewbJ0EqtqyUiHi+zBbIOalQnwdDE8zE6ka/z5T6QLY2jjriz6
DwtqLRRcSJrId3qY1ZbJRqxpq4rUmWJFHC4j8+t6Wh0qwYpO084p8n9Y2/ddqmCD
Po+aiDwvA8BlNDSpGp7gGztghuo9oljiUPHlM/evV4wI8/sPUNrZIc5d1gHJZDtB
PN9RcPA8+JhYzlxuifjVyLiyopR6kxjrn5HOMuQ3ZUaZjoHRPrRNNTv5Drr0zKr0
eEzshgR6e3LDFUB1QRC1Xg1ZGq2SwL2l+lqsJMSMnKH8jO8WBTjujS8CAQICAgFF
-----END DH PARAMETERS-----
```

:: on host
  cd relay
  scp -P 8022 \
    ./cmdeploy/src/cmdeploy/dovecot/auth.conf \
    ./cmdeploy/src/cmdeploy/dovecot/push_notification.lua \
    chat.example.com:/home/user/cm
  cd ..

doas chown root: auth.conf push_notification.lua
doas mv auth.conf push_notification.lua /etc/dovecot

doas sysctl -w fs.inotify.max_user_instances=65535
doas sysctl -w fs.inotify.max_user_watches=65535
doas vim /etc/sysctl.d/inotify.conf
::
```
fs.inotify.max_user_instances = 65535
fs.inotify.max_user_watches = 65535
```
